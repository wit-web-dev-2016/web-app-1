 <!DOCTYPE html>
 <html>
   <head>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

     

     <style>
       

body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}

.ui.segment.pushable
{
  margin: 0;
  padding: 1rem 0;
  overflow: visible;
}



     </style>

   </head>

  <body>
    

<style>
  

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom:thin solid black;
}

h2
{
  font-size:110%;
  border-bottom: thin solid black;
}

h3
{
  font-size:100%;
  border-bottom: thin solid black;
}

body
{
  overflow-y: scroll;
}

.pushable > .pusher
{
  padding-bottom: 1.5rem;
}

.ui.segment.pushable
{
  margin: 0;
  padding: 1rem 0;
  overflow: visible;
}



</style>

<div class="ui fixed top pointing inverted stackable menu labmenu">
  <header class="header item">
    <i id="toc" class="sitemap icon"></i>
    <a href="../index.html">
      Glitch: Model View Controller
    </a>
  </header>
  <div class="right tab-menu menu">
    
    <a class="item" data-tab="Lab-5 Gomix Playlist 3">
      Lab-5 Gomix Playlist 3
    </a>
    
    <a class="item" data-tab="Exercise Solutions">
      Exercise Solutions
    </a>
    
    <a class="item" data-tab="01">
      01
    </a>
    
    <a class="item" data-tab="02">
      02
    </a>
    
    <a class="item" data-tab="03">
      03
    </a>
    
    <a class="item" data-tab="04">
      04
    </a>
    
    <a class="item" data-tab="Exercises">
      Exercises
    </a>
    
    <div class="item">
      
    </div>
  </div>
</div>

<div class="ui segment pushable">
  <div class="ui inverted labeled icon left inline vertical sidebar menu">
    
      
        <a class="item" href="../../topic-01-css-frameworks/book-a/index.html">
          Lab-02a Semantic UI
        </a>
      
    
      
        <a class="item" href="../../topic-01-css-frameworks/book-b/index.html">
          Lab-02b Semantic UI
        </a>
      
    
      
        <a class="item" href="../../topic-02-glitch-intro/book-a-glitch-intro/index.html">
          Lab-1 Glitch Intro
        </a>
      
    
      
        <a class="item" href="../../topic-02-js-intro/book-a-js-introduction/index.html">
          Lab-2 JS Intro
        </a>
      
    
      
        <a class="item" href="../../topic-03-app-controllers+views/book-a-gomix-playlist-1/index.html">
          Lab-3 Gomix Playlist 1
        </a>
      
    
      
        <a class="item" href="../../topic-04-app-templates+views/book-a-gomix-playlist-2/index.html">
          Lab-4 Gomix Playlist 2
        </a>
      
    
      
        <a class="item" href="../../topic-05-app-models/book-a-gomix-playlist-3/index.html">
          Lab-5 Gomix Playlist 3
        </a>
      
    
      
        <a class="item" href="../../topic-06-gomark/book-a-gomark-1/index.html">
          Lab-gomark-1
        </a>
      
    
      
        <a class="item" href="../../topic-07-js-arrays/book-a-js-arrays/index.html">
          Lab-6 JS Arrays
        </a>
      
    
      
        <a class="item" href="../../topic-07-js-arrays/book-b-gomark-2/index.html">
          Lab-gomark-2
        </a>
      
    
      
        <a class="item" href="../../topic-08-gomix-sessions/book-a-gomark-3/index.html">
          Lab-gomark-3
        </a>
      
    
      
        <a class="item" href="../../topic-08-gomix-sessions/book-b-gomix-sessions/index.html">
          Lab-8 Gomix Sessions
        </a>
      
    
      
        <a class="item" href="../../topic-09-js-objects/book-a-js-objects/index.html">
          Lab-9 JS Objects
        </a>
      
    
      
        <a class="item" href="../../topic-10-gomix-images/book-a-setup/index.html">
          Lab-10a Cloudinary Setup
        </a>
      
    
      
        <a class="item" href="../../topic-10-gomix-images/book-b-gomix-cloudinary/index.html">
          Lab-10b gomix-picture-store
        </a>
      
    
      
        <a class="item" href="../../topic-11-js-functions/book-a-js-functions/index.html">
          Lab-11 Functions
        </a>
      
    
      
        <a class="item" href="../../topic-12-js-nested-objects/book-a-js-nested-objects/index.html">
          Lab-12 Nested Objects
        </a>
      
    
  </div>
  <div class="pusher" tabindex="-1">
    <div class="ui basic segment" id="labchat">
      <br>
      
      <div  class="ui tab segment lab" data-tab="Lab-5 Gomix Playlist 3">
        <h1>Objectives</h1>
<p>Enable Songs and Playlists to be added via simple forms.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="Exercise Solutions">
        <h1>Exercise Solutions</h1>
<p>This lab requires that the <code>Glitch-playlist-2</code> lab be completed. If you have lost your solution, create a new project in Glitch and select the <code>import from github</code> option and enter <code>edeleastar/Glitch-playlist-2</code> to import a completed version.</p>
<h2>Exercise 1: UX Enhancements &amp; Exercise 3: listplaylists partial</h2>
<p>Introduce a &#39;Delete Playlist&#39; button for each playlist, represented by a <code>trash</code> icon.</p>
<h2>views/dashboard.hbs</h2>
<pre><code class="lang-html">{{&gt; menu id=&quot;dashboard&quot;}}

&lt;section class=&quot;ui segment&quot;&gt;
  {{&gt; listplaylists}}
&lt;/section&gt;</code></pre>
<h2>views/partials/listplaylists.hbs</h2>
<pre><code class="lang-html">{{#each playlists}}
  &lt;section class=&quot;ui stacked segment&quot;&gt;
    &lt;h2 class=&quot;ui header&quot;&gt;
      {{title}}
    &lt;/h2&gt;
    &lt;p&gt; Total Duration: {{duration}} &lt;/p&gt;
    &lt;a href=&quot;/playlist/{{id}}&quot; class=&quot;ui icon button&quot;&gt;
      &lt;i class=&quot;icon folder open&quot;&gt;&lt;/i&gt;
    &lt;/a&gt;
    &lt;a href=&quot;/dashboard/deleteplaylist/{{id}}&quot; class=&quot;ui icon button&quot;&gt;
      &lt;i class=&quot;icon trash&quot;&gt;&lt;/i&gt;
    &lt;/a&gt;
  &lt;/section&gt;
{{/each}}</code></pre>
<h2>Exercise 2: Delete Playlist Functionality</h2>
<p>Make the button actually delete the denoted playlist.</p>
<h2>routes.js</h2>
<pre><code class="lang-js">...
router.get(&#39;/dashboard/deleteplaylist/:id&#39;, dashboard.deletePlaylist);
...</code></pre>
<h2>controllers/dashboard.js</h2>
<pre><code class="lang-js">...
  deletePlaylist(request, response) {
    const playlistId = request.params.id;
    logger.debug(`Deleting Playlist ${playlistId}`);
    playlistStore.removePlaylist(playlistId);
    response.redirect(&#39;/dashboard&#39;);
  },
...</code></pre>
<h2>models/playlist-store.js</h2>
<pre><code class="lang-js">  removePlaylist(id) {
    _.remove(this.playlistCollection, { id: id });
  },</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="01">
        <h1>Adding a Song</h1>
<p>Before adding a song, lets align the delete button appearance with the delete playlist. Use this icon button instead of the existing one:</p>
<pre><code class="lang-html">&lt;a href=&quot;/playlist/{{../playlist.id}}/deletesong/{{id}}&quot; class=&quot;ui icon button&quot;&gt;
  &lt;i class=&quot;icon trash&quot;&gt;&lt;/i&gt;
&lt;/a&gt;</code></pre>
<p>In order to add songs, we need this new partial which provides a simple add song form:</p>
<h2>views/partials/addsong.hbs</h2>
<pre><code class="lang-html">&lt;form class=&quot;ui stacked segment form&quot; action=&quot;/playlist/{{playlist.id}}/addsong&quot; method=&quot;POST&quot;&gt;
  &lt;div class=&quot;two fields&quot;&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;Title&lt;/label&gt;
      &lt;input placeholder=&quot;Title&quot; type=&quot;text&quot; name=&quot;title&quot;&gt;
    &lt;/div&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label&gt;Artist&lt;/label&gt;
      &lt;input placeholder=&quot;Artist&quot; type=&quot;text&quot; name=&quot;artist&quot;&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;button class=&quot;ui blue submit button&quot;&gt;Add Song&lt;/button&gt;
&lt;/form&gt;</code></pre>
<p>Then we need to include this in the playlist view:</p>
<h2>views/playlist.hbs</h2>
<pre><code>{{&gt; menu}}

&lt;section class=&quot;ui center aligned middle aligned segment&quot;&gt;
  &lt;h2 class=&quot;ui header&quot;&gt;
    {{playlist.title}}
  &lt;/h2&gt;
  {{&gt; listsongs}}
  {{&gt; addsong}}
&lt;/section&gt;</code></pre>
<p>This should now appear:</p>
<p><img src="img/01.png" alt=""></p>
<p>This requires a new route to support the <code>POST</code> action:</p>
<h2>routes.js</h2>
<pre><code class="lang-js">router.post(&#39;/playlist/:id/addsong&#39;, playlist.addSong);</code></pre>
<p>... and this new function in the <code>playlist</code> controller:</p>
<h2>controllers/playlist.js</h2>
<pre><code class="lang-js">...
  addSong(request, response) {
    const playlistId = request.params.id;
    const playlist = playlistStore.getPlaylist(playlistId);
    const newSong = {
      title: request.body.title,
      artist: request.body.artist,
    };
    playlistStore.addSong(playlistId, newSong);
    response.redirect(&#39;/playlist/&#39; + playlistId);
  },
...</code></pre>
<p>This is the implementation of the <code>addSong</code> method in the store:</p>
<h2>modiels/playlist-store.js</h2>
<pre><code class="lang-js">  addSong(id, song) {
    const playlist = this.getPlaylist(id);
    playlist.songs.push(song);
  },</code></pre>
<p>Try this now and verify that you can add songs.</p>
<p>Can you delete one of the songs you have just added? Can you delete one of the songs that have been in there already? Can you explain what is going wrong?</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="02">
        <h1>ID Management</h1>
<p>Deleting a song you have manually added using the form generates the following:</p>
<pre><code>Cannot GET /playlist/02/deletesong/</code></pre>
<p>However, pre-populated songs can still be deleted. What is going on here?</p>
<p>The issue is that the new songs we have added do not appear to have IDs. Looking at this list for instance:</p>
<p><img src="img/02.png" alt=""></p>
<p>Revealing the source:</p>
<p><img src="img/03.png" alt=""></p>
<p>Look at the last entry - there is no ID for the new song we added.</p>
<p>Here is our new <code>addsong</code> function again:</p>
<h2>controlers/paylist.js</h2>
<pre><code class="lang-js">  addSong(request, response) {
    const playlistId = request.params.id;
    const playlist = playlistStore.getPlaylist(playlistId);
    const newSong = {
      title: request.body.title,
      artist: request.body.artist,
    };
    playlistStore.addSong(playlistId, newSong);
    response.redirect(&#39;/playlist/&#39; + playlistId);
  },</code></pre>
<p>The object we are inserting has only two fields:</p>
<pre><code class="lang-js">    const newSong = {
      title: request.body.title,
      artist: request.body.artist,
    };</code></pre>
<p>We need to also insert a new, unique, ID for each object we create.</p>
<p>How do we create a new ID? This can be challenged in implement manually. However, one solution is to use Universally Unique Identifiers:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">https://en.wikipedia.org/wiki/Universally_unique_identifier</a></li>
</ul>
<p>A library to generate a uuid is already in our app, we just need to import and use it</p>
<p>At the top of the <code>playlist</code> controller, we require the library:</p>
<h2>controllers/playlists.js</h2>
<pre><code>const uuid = require(&#39;uuid&#39;);</code></pre>
<p>Now, when we are creating a playlist, we can use the library to generate a unique id for us:</p>
<pre><code class="lang-js">  const newSong = {
    id: uuid(),
    title: request.body.title,
    artist: request.body.artist,
  };</code></pre>
<p>Try this now and make sure the new songs can be deleted. View the source to reveal the uuid-style ids the new songs have.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="03">
        <h1>Adding playlists</h1>
<p>Modeled on the Song addition, we can quickly implement the necessary form, route, controller function and model update to support adding a new playlist.</p>
<h2>views/partials/addplaylist.hbs</h2>
<pre><code class="lang-html">&lt;form class=&quot;ui stacked segment form&quot; action=&quot;/dashboard/addplaylist&quot; method=&quot;POST&quot;&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label&gt;Title&lt;/label&gt;
    &lt;input placeholder=&quot;Title&quot; type=&quot;text&quot; name=&quot;title&quot;&gt;
  &lt;/div&gt;
  &lt;button class=&quot;ui blue submit button&quot;&gt;Add Playlist&lt;/button&gt;
&lt;/form&gt;</code></pre>
<h2>views/dashboard.hbs</h2>
<pre><code class="lang-html">{{&gt; menu id=&quot;dashboard&quot;}}

&lt;section class=&quot;ui segment&quot;&gt;
  {{&gt; listplaylists}}
  {{&gt; addplaylist}}
&lt;/section&gt;</code></pre>
<h2>routes.js</h2>
<pre><code class="lang-js">router.post(&#39;/dashboard/addplaylist&#39;, dashboard.addPlaylist);</code></pre>
<h2>controllers/dashboard.js</h2>
<pre><code class="lang-js">const uuid = require(&#39;uuid&#39;);
...
  addPlaylist(request, response) {
    const newPlayList = {
      id: uuid(),
      title: request.body.title,
      songs: [],
    };
    playlistStore.addPlaylist(newPlayList);
    response.redirect(&#39;/dashboard&#39;);
  },</code></pre>
<p>Notice we are again using the uuid library here to generate and ID for the new playlist</p>
<h2>modes/playlist-store.js</h2>
<pre><code class="lang-js">addPlaylist(playlist) {
  this.playlistCollection.push(playlist);
},</code></pre>
<p>We should now be able to add new playlists.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="04">
        <h1>Persistence</h1>
<p>You will note that, even though we are able to add/delete playlists/songs, every time the app restarts then we are left with the same initial playlist. i.e. none of the changes we make are <code>persisted</code> beyond the life of the program execution.</p>
<p>This is the field of databases - and beyond the scope of this course for the moment. However, we can implement something like a database, but simpler, which can serve our needs. Introduce this new class into the project:</p>
<h2>models/json-store.js</h2>
<pre><code class="lang-js">&#39;use strict&#39;;

const low = require(&#39;lowdb&#39;);
const fileAsync = require(&#39;lowdb/lib/file-async&#39;);

class JsonStore {
  constructor(file, defaults) {
    this.db = low(file, { storage: fileAsync, });
    this.db.defaults(defaults).value();
  }

  add(collection, obj) {
    this.db.get(collection).push(obj).last().value();
  }

  remove(collection, obj) {
    this.db.get(collection).remove(obj).value();
  }

  removeAll(collection) {
    this.db.get(collection).remove().value();
  }

  findAll(collection) {
    return this.db.get(collection).value();
  }

  findOneBy(collection, filter) {
    const results = this.db.get(collection).filter(filter).value();
    return results[0];
  }

  findByIds(collection, ids) {
    return this.db.get(collection).keyBy(&#39;id&#39;).at(ids).value();
  }

  findBy(collection, filter) {
    return this.db.get(collection).filter(filter).value();
  }
}

module.exports = JsonStore;</code></pre>
<p>This is a wrapper around this module:</p>
<ul>
<li><a href="https://github.com/typicode/lowdb">https://github.com/typicode/lowdb</a></li>
</ul>
<p>It will manage the json file we have been using, enabling updates in a convenient manner. You do not need to understand this module in depth for the moment, we will use another wrapper module to interact with it.</p>
<p>Here is the wraper, which is a new version of our playlist store module:</p>
<h2>modules/playlist-store.js</h2>
<pre><code class="lang-js">&#39;use strict&#39;;

const _ = require(&#39;lodash&#39;);
const JsonStore = require(&#39;./json-store&#39;);

const playlistStore = {

  store: new JsonStore(&#39;./models/playlist-store.json&#39;, { playlistCollection: [] }),
  collection: &#39;playlistCollection&#39;,

  getAllPlaylists() {
    return this.store.findAll(this.collection);
  },

  getPlaylist(id) {
    return this.store.findOneBy(this.collection, { id: id });
  },

  addPlaylist(playlist) {
    this.store.add(this.collection, playlist);
  },

  removePlaylist(id) {
    const playlist = this.getPlaylist(id);
    this.store.remove(this.collection, playlist);
  },

  removeAllPlaylists() {
    this.store.removeAll(this.collection);
  },

  addSong(id, song) {
    const playlist = this.getPlaylist(id);
    playlist.songs.push(song);
  },

  removeSong(id, songId) {
    const playlist = this.getPlaylist(id);
    const songs = playlist.songs;
    _.remove(songs, { id: songId});
  },
};

module.exports = playlistStore;</code></pre>
<p>No other changes are necessary - as all access to the playlist is via the above module.</p>
<p>The app should work now as before, except this time changes to the playlists will be <code>persisted</code> to the json file. This means that if the app has to be restarted, it will have preserved any changes to the playlist in the JSON file, which will be reloaded when the app restarts.</p>
<p>Try this now - and keep an eye on the <code>playlist-store.json</code> file. Because of the way Glitch works, you may only see the updated json when you refresh the page.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="Exercises">
        <h1>Exercises</h1>
<p>If you want to download a complete version of the app as it should be at the end of this lab, then create a new Glitch project, and import <code>edeleastar/Glitch-playlist-3</code>.</p>

      </div>
     
    </div>
  </div>
</div>
<!--<div class="ui bottom fixed borderless right menu">
  <div class="ui right tiny menu">
    <div class="ui mini message segment">
      .
      <a href="http://creativecommons.org/licenses/by-nc/4.0/"
         title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
         target="_blank">Creative Commons License
      </a>
    </div>
  </div>
</div>-->

<script>
  $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

</script>



    <footer>

    </footer>
    <script>
      $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

    </script>
  </body>

 </html>